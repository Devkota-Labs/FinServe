name: Backend CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build & Publish Artifact
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish Self-Contained Build
        run: |
          PROJECT_DIR="backend/src/FinServe.Api"
          OUT_DIR="backend/publish"
          echo "Publishing from $PROJECT_DIR to $OUT_DIR"
          dotnet restore "$PROJECT_DIR"
          dotnet publish "$PROJECT_DIR" \
            -c Release \
            -r linux-x64 \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            /p:PublishTrimmed=false \
            /p:TrimMode=Link \
            /p:DebugType=None \
            /p:DebugSymbols=false \
            -o "$OUT_DIR"

          echo "Removing appsettings from publish folder..."
          rm -f $OUT_DIR/appsettings*.json || true

          echo "Publish done. publish/ contents:"
          ls -la $OUT_DIR || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-self-contained
          path: backend/publish
          retention-days: 7

  deploy:
    name: Deploy to EC2 (Manual Approval)
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://54.81.12.127:5005
    concurrency: deploy-backend

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-self-contained
          path: publish

      - name: Create tarball (skip appsettings.json)
        run: |
          cd publish
          tar --exclude='appsettings*.json' -czf ../publish.tar.gz .
          cd ..
          echo "Created publish.tar.gz with size:"
          ls -lh publish.tar.gz

      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "publish.tar.gz"
          target: "/home/ec2-user/"

      - name: Extract and Restart Service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p /home/ec2-user/FinServeApi

            echo "üî¥ Stopping backend service..."
            sudo systemctl stop finserve || true

            echo "Ensuring process is terminated..."
            sleep 3
            sudo pkill -f "FinServe.Api" || true

            echo "Extracting new build to temp folder..."
            sudo rm -rf /home/ec2-user/tmp_publish
            sudo mkdir -p /home/ec2-user/tmp_publish
            sudo tar -xzf /home/ec2-user/publish.tar.gz -C /home/ec2-user/tmp_publish --overwrite

            echo "Replacing old files..."
            sudo rsync -a --exclude 'appsettings*.json' /home/ec2-user/tmp_publish/ /home/ec2-user/FinServeApi/

            sudo chmod +x /home/ec2-user/FinServeApi/FinServe.Api || true
            sudo chown -R ec2-user:ec2-user /home/ec2-user/FinServeApi
            sudo chmod -R 755 /home/ec2-user/FinServeApi

            sudo rm -f /home/ec2-user/publish.tar.gz
            sudo rm -rf /home/ec2-user/tmp_publish

            echo "Restarting service..."
            sudo systemctl daemon-reload
            sudo systemctl start finserve
            sudo systemctl status finserve --no-pager || true

      - name: Cleanup local publish tar
        run: rm -f publish.tar.gz

      - name: Send Email (Success)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üöÄ Backend Deployment Successful ‚Äì ${{ github.ref_name }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            Backend deployment completed successfully.
            Tag: ${{ github.ref_name }}
            Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Email (Failure)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚ùå Backend Deployment FAILED ‚Äì ${{ github.ref_name }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            Backend deployment FAILED.
            Tag: ${{ github.ref_name }}
            Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
