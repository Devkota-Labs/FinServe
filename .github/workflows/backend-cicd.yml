name: Backend CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build & Publish Artifact
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish Self-Contained Build
        run: |
          PROJECT_DIR="backend/src/FinServe.Api"
          OUT_DIR="backend/publish"

          echo "Publishing from $PROJECT_DIR to $OUT_DIR"
          dotnet restore "$PROJECT_DIR"

          dotnet publish "$PROJECT_DIR" \
            -c Release \
            -r linux-x64 \
            --self-contained true \
            /p:PublishSingleFile=true \
            /p:IncludeNativeLibrariesForSelfExtract=true \
            /p:PublishTrimmed=false \
            /p:TrimMode=Link \
            /p:DebugType=None \
            /p:DebugSymbols=false \
            -o "$OUT_DIR"

          echo "Removing appsettings from publish output..."
          rm -f "$OUT_DIR"/appsettings*.json || true

          echo "Publish folder contents:"
          ls -la "$OUT_DIR"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-self-contained
          path: backend/publish
          retention-days: 7

  deploy:
    name: Deploy to EC2 (Manual Approval)
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://54.81.12.127:5005
    concurrency: deploy-backend

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-self-contained
          path: publish

      - name: Create tarball (exclude appsettings)
        run: |
          cd publish
          tar --exclude='appsettings*.json' -czf ../publish.tar.gz .
          cd ..
          ls -lh publish.tar.gz

      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "publish.tar.gz"
          target: "/home/ec2-user/"

      - name: Extract, Deploy & Restart Service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            APP_DIR="/home/ec2-user/FinServeApi"
            TMP_DIR="/home/ec2-user/tmp_publish"

            echo "Stopping service..."
            sudo systemctl stop finserve || true
            sleep 3

            echo "Preparing directories..."
            sudo mkdir -p "$APP_DIR"
            sudo rm -rf "$TMP_DIR"
            sudo mkdir -p "$TMP_DIR"

            echo "Extracting artifact..."
            sudo tar -xzf /home/ec2-user/publish.tar.gz -C "$TMP_DIR"

            echo "Deploying new files (keeping appsettings)..."
            sudo rsync -a \
              --exclude 'appsettings*.json' \
              "$TMP_DIR"/ "$APP_DIR"/

            echo "Fixing permissions..."
            sudo chmod +x "$APP_DIR/FinServe.Api" || true
            sudo chown -R ec2-user:ec2-user "$APP_DIR"
            sudo chmod -R 755 "$APP_DIR"

            echo "Cleaning temp files..."
            sudo rm -f /home/ec2-user/publish.tar.gz
            sudo rm -rf "$TMP_DIR"

            echo "Starting service..."
            sudo systemctl daemon-reload
            sudo systemctl start finserve

            echo "Validating service..."
            sudo systemctl is-active finserve

      - name: Verify API is responding
        run: |
          sleep 5
          curl -f http://54.81.12.127:5005 || exit 1

      - name: Send Email (Success)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üöÄ Backend Deployment Successful ‚Äì ${{ github.ref_name }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            Backend deployment completed successfully.
            Branch: ${{ github.ref_name }}
            Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Email (Failure)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚ùå Backend Deployment FAILED ‚Äì ${{ github.ref_name }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            Backend deployment FAILED.
            Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
